<!DOCTYPE html>
<html lang="en" xmlns:th = "http://www.thymeleaf.org">
<th:block th:replace="~{/fragment/fragment :: setBody(~{ :: body})}">
    <th:block th:fragment="body">
        <main class="site-main" style="margin-bottom: 100px;">
            <div class="product_image_area">
                <div class="container">

                    <div>
                        <button id="payBtn">결제하기</button>
                    </div>

                </div>
            </div>
        </main>
    </th:block>
</th:block>

<script src="https://cdn.bootpay.co.kr/js/bootpay-3.3.2.min.js" type="application/javascript"></script>

<script th:inline="javascript">

    window.onload = function () {
        document.getElementById("payBtn").addEventListener('click', paymentRequest);
        var httpRequest;
        function paymentRequest() {
            httpRequest = new XMLHttpRequest();

            BootPay.request({
                price: '1000', //실제 결제되는 가격
                application_id: "60af67a5d8c1bd001e2bb733",
                name: '블링블링 마스카라', //결제창에서 보여질 이름
                pg: 'nicepay',
                method: 'card', //결제수단, 입력하지 않으면 결제수단 선택부터 화면이 시작합니다.
                show_agree_window: 0, // 부트페이 정보 동의 창 보이기 여부
                items: [
                    {
                        item_name: '나는 아이템', //상품명
                        qty: 1, //수량
                        unique: '123', //해당 상품을 구분짓는 primary key - itemId
                        price: 1000, //상품 단가
                        cat1: 'TOP', // 대표 상품의 카테고리 상, 50글자 이내
                        cat2: '티셔츠', // 대표 상품의 카테고리 중, 50글자 이내
                        cat3: '라운드 티', // 대표상품의 카테고리 하, 50글자 이내
                    }
                ],
                user_info: {
                    username: '사용자 이름',
                    email: '사용자 이메일',
                    addr: '사용자 주소',
                    phone: '010-1234-4567'
                },
                order_id: '고유order_id_1234', //고유 주문번호로, 생성하신 값을 보내주셔야 합니다.
                params: {callback1: '그대로 콜백받을 변수 1', callback2: '그대로 콜백받을 변수 2', customvar1234: '변수명도 마음대로'},
            }).error(function (data) {
                //결제 진행시 에러가 발생하면 수행됩니다.
                console.log(data);
            }).cancel(function (data) {
                //결제가 취소되면 수행됩니다.
                console.log(data);
            }).confirm(function (data) {
                //결제가 실행되기 전에 수행되며, 주로 재고를 확인하는 로직이 들어갑니다.
                //주의 - 카드 수기결제일 경우 이 부분이 실행되지 않습니다.
                console.log(data);
                var enable = true; // 재고 수량 관리 로직 혹은 다른 처리
                if (enable) {
                    BootPay.transactionConfirm(data); // 조건이 맞으면 승인 처리를 한다.
                } else {
                    BootPay.removePaymentWindow(); // 조건이 맞지 않으면 결제 창을 닫고 결제를 승인하지 않는다.
                }
            }).close(function (data) {
                // 결제창이 닫힐때 수행됩니다. (성공,실패,취소에 상관없이 모두 수행됨)
            }).done(function (data) {
                //결제가 정상적으로 완료되면 수행됩니다
                //비즈니스 로직을 수행하기 전에 결제 유효성 검증을 하시길 추천합니다.

                var receipt_id = data.receipt_id;

                httpRequest.onreadystatechange = executeResult;
                httpRequest.open("GET", "/receipt/"+receipt_id+"/price/"+1000)
                httpRequest.setRequestHeader("Content-Type", "application/json")
                httpRequest.send();

                console.log(data);
            });
        }

        function executeResult() {
            try {
                if(httpRequest.readyState === XMLHttpRequest.DONE) {
                    if(httpRequest.status === 200) {
                        //  NOTE : 결제 완료페이지로 이동
                        console.log(httpRequest.responseText);
                        window.location.href = "/pay-result/"+httpRequest.responseText;
                    } else {
                        // NOTE: 결제 실패페이지로 이동
                        alert(httpRequest.responseText);
                        return;
                    }
                }
            } catch (e) {
                alert("Caught : " + e.description);
            }
        }
    }

</script>
</body>
</html>