<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<th:block th:replace="~{fragment/fragment :: setBody(~{ :: body})}">
    <th:block th:fragment="body">

        <main class="site-main" style="padding: 50px 40px;">
            <section style="display: flex; margin-bottom: 100px;">
                <th:block th:replace="fragment/mypage-menu :: mypage-menu">
                </th:block>
                <div style="float: right; width: 85%;">
                    <section>
                        <div style="display: flex; align-items: center; border-bottom: 3px solid #000000; padding-bottom: 14px; margin-top: 48px; font-size: 14px; position: relative; line-height: 1.5;">
                            <h1 style="display: inline-block; font-size: 24px;">기본 회원정보</h1>
                        </div>
                        <table style="width: 100%; line-height: 1.5; font-size: 14px; border-collapse: collapse; table-layout: fixed;">
                            <tbody>
                                <tr>
                                    <th style="text-align: left; font-weight: normal; vertical-align: top; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px;">
                                        이메일(아이디)
                                    </th>
                                    <td style="vertical-align: middle; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px; text-align: left;">
                                        <strong id="email" style="vertical-align: middle">[[${member.email}]]</strong>
                                    </td>
                                    <td style="vertical-align: middle; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px; text-align: left;">

                                    </td>
                                </tr>
                                <tr>
                                    <th style="text-align: left; font-weight: normal; vertical-align: top; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px;">
                                        이름
                                    </th>
                                    <td style="vertical-align: middle; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px; text-align: left;">
                                        <input id="name" type="text" style="vertical-align: middle" th:value="${member.name}">
                                    </td>
                                    <td style="vertical-align: middle; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px; text-align: left;">

                                    </td>
                                </tr>

                                <tr>
                                    <th style="text-align: left; font-weight: normal; vertical-align: top; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px;">
                                        핸드폰 번호
                                    </th>
                                    <td style="vertical-align: middle; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px; text-align: left;">
                                        <input id="phone" type="text" style="vertical-align: middle" th:value="${member.phone}">
                                    </td>
                                    <td style="vertical-align: middle; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px; text-align: left;">

                                    </td>
                                </tr>
                            </tbody>

                        </table>
                    </section>
                    <section>
                        <div style="display: flex; align-items: center; border-bottom: 3px solid #000000; padding-bottom: 14px; margin-top: 48px; font-size: 14px; position: relative; line-height: 1.5;">
                            <h1 style="display: inline-block; font-size: 24px;">
                                배송지 설정
                            </h1>
                            <button id="setPost" style="margin: -5px 5px; min-width: 100px; border: 1.5px solid #e5e5e5; background-color: #000000; color: #e8e8e8;">
                                주소찾기
                            </button>
                        </div>
                        <table style="width: 100%; line-height: 1.5; font-size: 14px; border-collapse: collapse; table-layout: fixed;">
                            <tbody>
                                <tr>
                                    <th style="text-align: left; font-weight: normal; vertical-align: top; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px;">
                                        우편번호
                                    </th>
                                    <td style="vertical-align: middle; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px; text-align: left;">
                                        <input id="postCode" type="text" style="vertical-align: middle" th:value="${member.address.zipcode}" disabled>
                                    </td>
                                    <td style="vertical-align: middle; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px; text-align: left;">
                                    </td>
                                </tr>
                                <tr>
                                    <th style="text-align: left; font-weight: normal; vertical-align: top; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px;">
                                        도로명 주소
                                    </th>
                                    <td style="vertical-align: middle; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px; text-align: left;">
                                        <input id="extraAddress" type="text" style="vertical-align: middle; width: 300px;" th:value="${member.address.extraAddress}" disabled>
                                    </td>
                                    <td style="vertical-align: middle; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px; text-align: left;">
                                    </td>
                                </tr>
                                <tr>
                                    <th style="text-align: left; font-weight: normal; vertical-align: top; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px;">
                                        상세주소
                                    </th>
                                    <td style="vertical-align: middle; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px; text-align: left;">
                                        <input id="detailsAddress" type="text" style="vertical-align: middle" th:value="${member.address.detailsAddress}">
                                    </td>
                                    <td style="vertical-align: middle; height: auto; padding:15px 0; box-sizing: border-box; border-top: 1px solid #f1f1f1; border-bottom: none; font-size: 14px; text-align: left;">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </section>
                    <section style="text-align: center; margin-top: 45px;">
                        <div>
                            <button id="modify" style="margin: 0 1px; border: 1px solid #000000; background-color: #000000; min-width: 290px; height: 60px; line-height: 54px; padding-top: 4px; font-size: 20px; color: #ffffff;">
                                변경하기
                            </button>
                        </div>
                    </section>
                </div>
            </section>
        </main>

    </th:block>
</th:block>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script th:inline="javascript">
    window.onload = function() {
        // Element Connection
        const setPostBtn = document.getElementById("setPost");
        const modifyBtn = document.getElementById("modify");

        let postCode = document.getElementById("postCode");
        let extraAddress = document.getElementById("extraAddress");

        var httpRequest;

        // Event Connection
        setPostBtn.addEventListener("click", openAddressSearchWindow);
        modifyBtn.addEventListener("click", modifyMemberRequest);

        // Event
        function modifyMemberRequest() {
            let modifyObj = getModifyMemberDto();

            requestAPI(modifyResult, "PUT", "/api/member", modifyObj);
        }

        function getHttpInstance() {
            if(!httpRequest) {
                httpRequest = new XMLHttpRequest();
            }

            return httpRequest;
        }

        function requestAPI(e, type, url, data) {
            const jsonParsedData = data ? JSON.stringify(data) : null;

            httpRequest = getHttpInstance();

            httpRequest.onreadystatechange = e;
            httpRequest.open(type, url);
            httpRequest.setRequestHeader("Content-Type", "application/json")
            httpRequest.send(jsonParsedData);
        }

        function getModifyMemberDto() {
            var obj = {
                name : document.getElementById("name").value,
                phone : document.getElementById("phone").value,
                zipcode: document.getElementById("postCode").value,
                extraAddress : document.getElementById("extraAddress").value,
                detailsAddress : document.getElementById("detailsAddress").value,
            }
            console.log(obj);

            return obj;
        }

        function modifyResult() {
            try {
                if (httpRequest.readyState === XMLHttpRequest.DONE) {
                    if (httpRequest.status === 200) {
                        alert(httpRequest.responseText);
                        window.location.reload();
                    } else {
                        alert(httpRequest.responseText);
                        return;
                    }
                }
            }
            catch( e ) {
                alert('Caught Exception: ' + e.description);
            }
        }

        // PostCode API
        function openAddressSearchWindow() {
            new daum.Postcode({
                oncomplete: function(data) {

                    var roadAddr = data.roadAddress; // 도로명 주소 변수
                    var extraRoadAddr = ''; // 참고 항목 변수
                    // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                    // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                    if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                        extraRoadAddr += data.bname;
                    }
                    // 건물명이 있고, 공동주택일 경우 추가한다.
                    if(data.buildingName !== '' && data.apartment === 'Y'){
                        extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                    if(extraRoadAddr !== ''){
                        extraRoadAddr = ' (' + extraRoadAddr + ')';
                    }

                    // 우편 주소와 해당 필드 넣기
                    postCode.value = data.zonecode;
                    extraAddress.value = roadAddr+" "+extraRoadAddr;
                }
            }).open();
        }
    }
</script>

</body>
</html>